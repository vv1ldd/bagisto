version: '3.8'

# Local dev compose — запуск: docker compose -f docker-compose.local.yml up --build
# Сайт: http://localhost:8000
# Admin: http://localhost:8000/admin
# Mailpit UI: http://localhost:8025

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: bagisto-app-local
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      APP_NAME: "Meanly"
      APP_ENV: "local"
      APP_KEY: "${APP_KEY}"
      APP_DEBUG: "true"
      APP_URL: "http://localhost:8000"
      APP_ADMIN_URL: "admin"
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: "3306"
      DB_DATABASE: bagisto
      DB_USERNAME: bagisto
      DB_PASSWORD: secret
      REDIS_HOST: redis
      REDIS_PASSWORD: "null"
      REDIS_PORT: "6379"
      MAIL_MAILER: smtp
      MAIL_HOST: mailpit
      MAIL_PORT: "1025"
      MAIL_FROM_ADDRESS: "noreply@meanly.local"
      MAIL_FROM_NAME: "Meanly"
      SESSION_DRIVER: file
      CACHE_STORE: file
      QUEUE_CONNECTION: sync
      SCOUT_DRIVER: database
    volumes:
      - bagisto-storage-local:/var/www/html/storage
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - bagisto-local

  mysql:
    image: mysql:8.0
    container_name: bagisto-mysql-local
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: bagisto
      MYSQL_USER: bagisto
      MYSQL_PASSWORD: secret
      MYSQL_ROOT_PASSWORD: rootsecret
    ports:
      - "3307:3306" # 3307 чтобы не конфликтовать с локальным MySQL
    volumes:
      - bagisto-mysql-local:/var/lib/mysql
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "bagisto", "-psecret" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - bagisto-local

  redis:
    image: redis:7-alpine
    container_name: bagisto-redis-local
    restart: unless-stopped
    networks:
      - bagisto-local

  mailpit:
    image: axllent/mailpit:latest
    container_name: bagisto-mailpit-local
    restart: unless-stopped
    ports:
      - "8025:8025"
    networks:
      - bagisto-local

networks:
  bagisto-local:
    driver: bridge

volumes:
  bagisto-mysql-local:
    driver: local
  bagisto-storage-local:
    driver: local
